# Discovery 假设工厂 — 需求文档

## 模块定位
策略发现引擎，自动检测市场异常、生成策略假设、验证并晋升为证人。

## 宪法级原则
1. 假设工厂是策略来源，不是策略执行者
2. 生成的证人必须遵守现有架构约束（策略无下单权）
3. 所有假设必须通过统计验证才能晋升
4. 晋升的证人进入观察期，不直接参与实盘
5. 弱信号导向（52-55% 胜率即可）

## 功能需求

### FR-1: 异常检测
- FR-1.1: 波动率异常检测（压缩/释放）
- FR-1.2: 成交量异常检测（放量/缩量）
- FR-1.3: 资金费率异常检测（极端值）
- FR-1.4: 清算密度异常检测（清算潮）
- FR-1.5: 订单簿失衡检测（买卖深度比）

### FR-2: 假设生成
- FR-2.1: 从异常事件生成假设
- FR-2.2: 假设包含机械化事件定义
- FR-2.3: 假设包含预期方向和胜率范围
- FR-2.4: 假设参数可配置

### FR-3: 候选池管理
- FR-3.1: 假设状态管理（NEW → VALIDATING → TIER_X / FAIL）
- FR-3.2: 候选池容量限制（最大 100 个）
- FR-3.3: 假设生命周期管理
- FR-3.4: 假设归档和清理

### FR-4: 统计验证
- FR-4.1: 方向偏移检验（p-value）
- FR-4.2: 胜率检验
- FR-4.3: 效应量检验（Cohen's d）
- FR-4.4: 参数鲁棒性检验（±20%）
- FR-4.5: 与现有证人相关性检验（< 0.7）

### FR-5: 证人晋升
- FR-5.1: TIER_1/TIER_2 假设自动晋升
- FR-5.2: 动态生成证人类（继承 BaseStrategy）
- FR-5.3: 注册到 WitnessRegistry
- FR-5.4: 初始化健康度

### FR-6: 反馈优化
- FR-6.1: 收集晋升证人表现数据
- FR-6.2: 调整检测器参数
- FR-6.3: 优化假设生成策略

## 非功能需求

### NFR-1: 代码复用
- 复用 `src/data/api.py` 获取数据
- 复用 `src/learning/statistics.py` 统计验证
- 复用 `src/strategy/base.py` 证人基类
- 复用 `src/strategy/registry.py` 证人注册

### NFR-2: 资源限制
- 候选池最大容量：100 个假设
- 每日最大生成：10 个假设
- 验证并行度：5 个假设

### NFR-3: 调度频率
- 异常检测：每小时
- 假设生成：每日
- 统计验证：每周
- 晋升检查：每周

### NFR-4: 可追溯
- 假设来源可追溯（检测器 + 事件）
- 验证结果有完整日志
- 晋升历史可查询

## 约束条件
- 生成的证人必须继承 BaseStrategy
- 生成的证人只能输出 Claim，不能下单
- 假设验证需要足够样本量（> 100 次事件）
- 晋升的证人默认进入观察期

## 验证标准

| 等级 | p-value | 胜率 | 效应量 | 结果 |
|------|---------|------|--------|------|
| TIER_1 | < 0.05 | 52-55% | Cohen's d > 0.3 | 核心证人 |
| TIER_2 | < 0.20 | 51-53% | Cohen's d > 0.2 | 辅助证人 |
| TIER_3 | < 0.30 | 50-52% | Cohen's d > 0.1 | 观察期 |
| FAIL | ≥ 0.30 | < 50% | - | 归档 |
