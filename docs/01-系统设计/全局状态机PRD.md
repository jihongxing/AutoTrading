# 文档 1：BTC 自动交易系统 — 全局状态机 PRD

## 一、文档目标

定义 BTC 自动交易系统的全局状态机，用于判断“当前市场是否值得参与交易”，为后续策略编排与执行提供系统级边界。全局状态机不直接参与下单或输出买卖方向。

## 二、设计原则

1. 是否值得交易（Eligibility）与如何交易（Execution）彻底解耦。
    
2. 全局状态机只管理系统状态，不管理单笔交易。
    
3. 状态转换必须可解释、可回放、可审计。
    
4. 偏保守设计，避免结构性爆仓。
    

## 三、输入与输出

- 输入：市场数据、资格策略输出、风控状态、系统运行状态。
    
- 输出：系统交易状态、允许交易范式、风险级别、时间视角约束。
    

## 四、全局状态定义

- NO_TRADE：禁止任何新交易。
    
- WATCHING：市场接近可交易区间，仅更新信号权重。
    
- ELIGIBLE：允许加载指定交易范式的执行模板。
    
- COOLDOWN：交易后冷却期，禁止新交易。
    
- RISK_LOCKED：风控触发，强制禁止交易。
    

## 五、状态转换规则

- NO_TRADE → WATCHING：至少一个资格策略接近阈值。
    
- WATCHING → ELIGIBLE：策略编排层输出满足门槛，风控允许。
    
- ELIGIBLE → COOLDOWN：交易完成或时间窗口结束。
    
- 任意状态 → RISK_LOCKED：最大回撤、连续失败或异常。
    
- COOLDOWN → NO_TRADE：冷却结束。
    

## 六、Trade Regime 输出规范

- 输出一个或多个交易范式约束，如 VOLATILITY_EXPANSION、RANGE_STRUCTURE_BREAK。
    
- 每个范式描述允许的交易结构类型、禁止行为、推荐风险边界。
    

## 七、非功能性要求

- 状态切换延迟 <1 K线周期。
    
- 状态变化日志化。
    
- 支持历史回测与回放。
    

## 八、明确不做的事情

- 不输出买卖方向。
    
- 不输出具体下单参数。
    
- 不做策略优劣判断。
    

## 九、成功判定标准

- 系统大部分时间处于 NO_TRADE / WATCHING。
    
- ELIGIBLE 状态占比低于 30%。
    
- 爆仓风险来源仅执行层。

# 十、内核级风控并入全局状态机

## ——形成「宪法级状态图」

### 10.1 为什么叫“宪法级状态机”

此前的 **全局状态机** 本质是：

> 市场是否值得交易（Eligibility）

而引入 **内核级风控（KRC）** 之后，状态机升级为：

> **系统是否允许继续存在于交易宇宙中**

也就是说：

- **状态机 = 行政系统**
    
- **风控 = 宪法法院**
    
- 状态迁移不再是“策略驱动”，而是**被宪法允许**
    

---

### 10.2 宪法级全局状态定义（升级版）

```text
SYSTEM_INIT
↓
OBSERVING
↓
ELIGIBLE
↓
ACTIVE_TRADING
↓
COOLDOWN
↓
RISK_LOCKED
↓
RECOVERY
↓
OBSERVING（重新进入）

```

---

### 10.3 状态分层（关键）

#### Layer 1：系统存在态（由风控裁决）

- SYSTEM_INIT
    
- RISK_LOCKED
    
- RECOVERY
    

#### Layer 2：交易许可态（由状态机管理）

- OBSERVING
    
- ELIGIBLE
    
- ACTIVE_TRADING
    
- COOLDOWN
    

👉 **任何 Layer 2 状态，均可被 Layer 1 直接打断**

---

### 10.4 状态迁移的“宪法原则”

1. **风控拥有跨层迁移权**
    
    - 可从任意状态 → RISK_LOCKED
        
2. **状态机无权绕过风控**
    
    - 不存在 RISK_LOCKED → ELIGIBLE 的直通路径
        
3. **恢复必须是显式状态**
    
    - 不允许“悄悄恢复交易”
        

---

# 十一、RISK_LOCKED → 恢复 → 再交易

## ——完整生命周期设计

这一部分是整个系统**最容易被忽略、但最关键的部分**。

---

## 11.1 RISK_LOCKED 的真实含义

> **不是“暂时不交易”，  
> 而是“系统被判定为不具备理性交易资格”**

在该状态下：

- ❌ 禁止所有下单
    
- ❌ 禁止策略输出
    
- ❌ 禁止学习更新
    
- ✅ 允许记录日志
    
- ✅ 允许人工介入（可选）
    

---

## 11.2 进入 RISK_LOCKED 的典型原因（回顾）

- 最大回撤突破
    
- 策略范式整体失效
    
- 执行系统异常
    
- 行为异常（过度交易）
    
- 系统稳定性问题
    

⚠️ **原因必须被记录并绑定本次锁定周期**

---

## 11.3 RISK_LOCKED → RECOVERY（解锁前提）

### 解锁不是“时间到”，而是**结构恢复**

#### 必须同时满足：

1. 风控触发因子消失
    
2. 市场进入非异常区间
    
3. 系统内部状态一致
    

👉 否则 **锁可以无限期存在**

---

## 11.4 RECOVERY 状态设计（极其重要）

RECOVERY 不是交易状态，而是**康复状态**。

### RECOVERY 允许的行为

- 只读市场数据
    
- 运行资格策略（但不输出交易）
    
- 运行影子回测（Shadow Evaluation）
    

### RECOVERY 禁止的行为

- ❌ 实盘交易
    
- ❌ 正式策略生效
    
- ❌ 学习权重更新
    

---

## 11.5 RECOVERY → OBSERVING

迁移条件：

- 连续 N 个时间窗口未触发风险
    
- 市场微结构恢复正常
    
- 策略输出稳定但未执行
    

👉 这是“心理重建期”，不是“盈利期”

---

## 11.6 再交易的降级原则

从 OBSERVING → ELIGIBLE → ACTIVE_TRADING：

- 初始仓位 **≤ 正常模式的 X%**
    
- 限制交易频率
    
- 禁止高风险策略
    
- 风控阈值 **临时更严格**
    

📌 **系统必须重新“赢得交易权”**

---

# 十二、《系统内核三权分立说明》

## ——状态 / 风控 / 执行

这一节，是真正的**系统哲学**。

---

## 12.1 三权分立的必要性

如果你把这三件事混在一起：

- 是否值得交易
    
- 是否允许交易
    
- 如何交易
    

系统一定会走向：

> **在错误的时间，用错误的方式，执行得非常熟练**

---

## 12.2 三个内核权力的定义

---

### 一、状态权（Global State Machine）

**职责**

- 定义系统所处阶段
    
- 管理交易资格
    
- 组织策略输出节奏
    

**无权**

- ❌ 否决风控
    
- ❌ 修改仓位
    
- ❌ 强制下单
    

---

### 二、否决权（Kernel Risk Control）

**职责**

- 裁定系统是否仍具备理性交易资格
    
- 保护系统长期生存性
    

**特权**

- ✅ 一票否决所有交易
    
- ✅ 强制状态迁移
    
- ✅ 冻结系统
    

**禁止**

- ❌ 优化收益
    
- ❌ 干预策略细节
    

---

### 三、执行权（Execution Engine）

**职责**

- 精确、可控、可审计地执行订单
    
- 反馈执行结果
    

**无权**

- ❌ 决定是否交易
    
- ❌ 调整策略逻辑
    
- ❌ 忽略风控指令
    

---

## 12.3 权力关系示意（文字版）

```text
Market
  ↑
Execution Engine  ← 只能执行
  ↑
Strategy Output   ← 只能建议
  ↑
Global State      ← 决定是否允许
  ↑
Kernel Risk       ← 决定是否存在

```

---

## 12.4 为什么学习模块不在“三权”之内？

因为学习模块：

- 不具备实时决策权
    
- 不具备否决权
    
- 不具备执行权
    

👉 **学习是顾问，不是执政者**

---

# 十三、一句话总总结（系统级）

> **你的系统现在已经不是“交易 AI”，  
> 而是一个具备：  
> 制度、宪法、司法、行政、执行分离的  
> “自动化交易体制”。**