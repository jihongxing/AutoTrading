# BTC 自动交易系统 — 策略候选池 → 验证 → 内核接入闭环（完整版）

> **文档定位**：系统级策略生命周期管理  
> **核心认知**：在高效市场中，不存在"强信号"。系统价值在于持续发现、验证、组合弱信号，通过大样本累积实现长期稳定盈利。  
> **核心目标**：建立"假设工厂 → 验证 → 工程化 → 优化"的完整闭环

---

## 一、完整闭环流程图

```text
┌─────────────────────────────────────────────────────────┐
│                  假设工厂 (Hypothesis Factory)                │
│ ─────────────────────────────────────────────────────── │
│ 1. 数据驱动挖掘                                            │
│    - 异常检测：波动率突变、成交量异常、价格跳跃              │
│    - 相关性分析：多维特征相关性矩阵                         │
│    - 因果推断：Granger 因果检验、事件研究法                 │
│    - 模式识别：聚类分析、时间序列分割                       │
│                                                            │
│ 2. 人工假设提出                                            │
│    - 学术论文启发                                          │
│    - 市场观察启发                                          │
│    - 交易员经验启发                                        │
│                                                            │
│ 3. 假设标准化输出                                          │
│    - H₀ vs H₁ 明确定义                                    │
│    - 事件定义（机械化、可复现）                             │
│    - 观察变量定义                                          │
│    - 预期效应方向                                          │
└───────────────────────┬─────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│              策略候选池 (Hypothesis Pool)                    │
│ ─────────────────────────────────────────────────────── │
│ 状态标记：PENDING / VALIDATING / PASS / WEAK / FAIL       │
│                                                            │
│ - 高频微结构类 (PENDING)                                   │
│   资金费率套利 / 三角套利 / 订单簿失衡 / 大单冲击           │
│                                                            │
│ - 中频方向类 (VALIDATING)                                  │
│   清算密度 / 清算热力图 / 资金费率极端 / 持仓量异常          │
│                                                            │
│ - 长周期高级类 (PENDING)                                   │
│   特征工程 ML / 强化学习 / 链上巨鲸 / 交易所净流入流出       │
│                                                            │
│ - 数据挖掘发现类 (NEW)                                     │
│   系统自动发现的异常模式                                    │
└───────────────────────┬─────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│           策略验证层 (Hypothesis Validation)                │
│ ─────────────────────────────────────────────────────── │
│ 验证标准（学术级）：                                        │
│                                                            │
│ 1. 事件定义合格性检查                                      │
│    - 完全机械化（无主观判断）                               │
│    - 参数鲁棒性（±20% 不翻转）                             │
│                                                            │
│ 2. 三大统计量检验                                          │
│    ✓ 方向偏移：p_dir < 0.01                               │
│    ✓ 波动持续：p_vol < 0.05, Cohen's d > 0.2             │
│    ✓ 信息增益：KL > 0.01                                  │
│                                                            │
│ 3. 反事实检验（必须）                                      │
│    - 随机对照组验证                                        │
│    - 真事件 vs 伪事件显著差异                              │
│                                                            │
│ 4. 判决输出                                                │
│    PASS：可工程化                                          │
│    WEAK：降级为研究框架                                    │
│    FAIL：停止工程化，考虑替代假设                           │
└───────────────────────┬─────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│          策略抽象化层 (Strategy Abstraction)                │
│ ─────────────────────────────────────────────────────── │
│ 通过验证的策略封装成"证人"（Witness）                        │
│                                                            │
│ 证人分级：                                                 │
│ - 核心证人（高权重，可触发交易）                            │
│ - 辅助证人（提供加分/削弱）                                │
│ - 否决证人（仅否决权）                                     │
│ - 风控证人（硬否决权）                                     │
│                                                            │
│ 证人接口标准化：                                           │
│ - 输入：市场数据 + 系统状态                                │
│ - 输出：Claim（声明）+ Confidence（置信度）                │
│ - 约束：不直接下单，不感知账户                             │
└───────────────────────┬─────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│            内核执行层 (Minimal Kernel)                      │
│ ─────────────────────────────────────────────────────── │
│ 宪法级三权分立：                                           │
│                                                            │
│ 1. 状态权（全局状态机）                                    │
│    - 决定是否允许交易                                      │
│    - 状态：OBSERVING / ELIGIBLE / ACTIVE / COOLDOWN /     │
│            RISK_LOCKED / RECOVERY                         │
│                                                            │
│ 2. 否决权（内核级风控）                                    │
│    - 硬否决所有交易                                        │
│    - 五大风险域监控                                        │
│    - 强制进入 RISK_LOCKED                                 │
│                                                            │
│ 3. 执行权（执行引擎）                                      │
│    - 忠实执行批准指令                                      │
│    - 幂等、可回滚、可审计                                  │
│    - 仓位管理、止盈止损                                    │
│                                                            │
│ 证人信号融合 → 裁决 → 风控审批 → 执行                      │
└───────────────────────┬─────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│         自学习自优化闭环 (Learning & Optimization)          │
│ ─────────────────────────────────────────────────────── │
│ 1. 实盘反馈收集                                            │
│    - 每笔交易：信号来源、执行结果、盈亏                     │
│    - 证人表现：成功率、夏普比率、最大回撤                   │
│    - 市场环境：波动率、流动性、极端事件                     │
│                                                            │
│ 2. 证人权重优化                                            │
│    - 成功率 > 70% → 增加权重 5-10%                        │
│    - 成功率 < 40% → 减少权重 5-10%                        │
│    - 连续失败 → 临时沉默（Mute）                           │
│    - 多次触发风控 → 封禁（Ban）                            │
│                                                            │
│ 3. 假设工厂反馈                                            │
│    - 失效证人 → 分析失效原因 → 生成新假设                  │
│    - 成功证人 → 分析成功特征 → 生成相似假设                │
│    - 市场结构变化 → 触发新一轮数据挖掘                     │
│                                                            │
│ 4. 候选池动态更新                                          │
│    - 新假设自动加入候选池                                  │
│    - 失效假设标记为 DEPRECATED                             │
│    - 形成持续进化的策略生态                                │
└───────────────────────┬─────────────────────────────────┘
                        │
                        └──────► 回到假设工厂（闭环）

```

---

## 二、假设工厂详细设计

### 2.1 数据驱动挖掘引擎

#### A. 异常检测模块

**目标**：自动发现市场异常行为

**方法**：
1. **统计异常**
   - Z-score 检测（> 3σ）
   - MAD（中位数绝对偏差）
   - 滚动分位数（P95, P99）

2. **时间序列异常**
   - ARIMA 残差分析
   - 结构突变检测（Chow Test）
   - 季节性分解异常

3. **多维异常**
   - Isolation Forest
   - Local Outlier Factor (LOF)
   - DBSCAN 聚类离群点

**输出**：
- 异常事件时间戳
- 异常类型标签
- 异常强度评分

**示例假设生成**：
```
发现：价格在 15:00-16:00 UTC 频繁出现 > 3σ 波动
假设：特定时间窗口存在流动性不足，导致价格易被操纵
验证：比较该时间窗口 vs 其他时间的价格稳定性
```

---

#### B. 相关性分析模块

**目标**：发现特征之间的非随机关系

**方法**：
1. **线性相关**
   - Pearson 相关系数矩阵
   - 滚动相关性（时变）
   - 偏相关分析（控制混淆变量）

2. **非线性相关**
   - Spearman 秩相关
   - Kendall τ 相关
   - 互信息（Mutual Information）

3. **滞后相关**
   - 交叉相关函数（CCF）
   - 动态时间规整（DTW）
   - 领先-滞后关系矩阵

**输出**：
- 高相关特征对（|r| > 0.7）
- 滞后关系（X 领先 Y k 个周期）
- 相关性稳定性评分

**示例假设生成**：
```
发现：资金费率与未来 8 小时价格变化相关性 r = -0.65
假设：极端资金费率预示价格反转
验证：资金费率 > P95 时，未来价格是否显著下跌
```

---

#### C. 因果推断模块

**目标**：区分相关性和因果性

**方法**：
1. **Granger 因果检验**
   - X 的历史是否有助于预测 Y
   - 双向因果检验
   - 多变量 Granger 因果

2. **事件研究法**
   - 定义事件窗口（-T, +T）
   - 计算异常收益（AR）
   - 累积异常收益（CAR）

3. **工具变量法**
   - 寻找外生冲击
   - 两阶段最小二乘（2SLS）
   - 差分中的差分（DID）

**输出**：
- 因果关系强度（p-value）
- 因果方向（X → Y）
- 因果滞后期

**示例假设生成**：
```
发现：清算量 Granger 导致价格变化（p < 0.01, lag=2）
假设：清算密度超过阈值会触发价格级联
验证：清算量 > P90 时，未来价格加速度是否显著增加
```

---

#### D. 模式识别模块

**目标**：发现重复出现的市场结构

**方法**：
1. **聚类分析**
   - K-means（市场状态聚类）
   - 层次聚类（相似模式分组）
   - GMM（高斯混合模型）

2. **时间序列分割**
   - 隐马尔可夫模型（HMM）
   - 变点检测（Changepoint Detection）
   - 状态空间模型

3. **形态识别**
   - 动态时间规整（DTW）
   - Shapelet 提取
   - 符号化聚合近似（SAX）

**输出**：
- 市场状态分类（N 个状态）
- 状态转换概率矩阵
- 典型模式库

**示例假设生成**：
```
发现：市场存在 3 个稳定状态（低波、震荡、趋势）
假设：状态转换时刻存在交易机会
验证：状态转换后 K 个周期的收益是否显著 > 0
```

---

### 2.2 人工假设提出流程

#### A. 学术论文启发

**流程**：
1. 定期扫描 arXiv / SSRN / Google Scholar
2. 筛选高引用论文（> 50 引用）
3. 提取核心假设和验证方法
4. 适配到 BTC 市场

**示例**：
```
论文：《Order Flow Toxicity and Liquidity in Cryptocurrency Markets》
核心假设：有毒订单流（Toxic Flow）导致流动性提供者撤单
适配：检测 BTC 订单簿深度突然下降事件
```

---

#### B. 市场观察启发

**流程**：
1. 监控市场异常事件（闪崩、暴涨）
2. 事后分析：数据复盘、新闻关联
3. 提出解释性假设
4. 设计验证方案

**示例**：
```
观察：2024-03-15 BTC 闪崩 15%，随后快速反弹
分析：大量止损单被触发 → 流动性枯竭 → 价格超调
假设：止损密集区被触发后，价格倾向于反转
```

---

#### C. 交易员经验启发

**流程**：
1. 收集交易员观察（论坛、社交媒体）
2. 提取可量化的市场规律
3. 转化为机械化假设
4. 严格验证

**示例**：
```
经验："资金费率爆表时，价格往往见顶"
量化：资金费率 > 0.3% 时，未来 24h 价格下跌概率
假设：极端资金费率预示过度杠杆，容易回调
```

---

### 2.3 假设标准化输出格式

**每个假设必须包含**：

```markdown
## 假设 ID：HYP-2026-001

### 1. 假设陈述
**H₀（零假设）**：清算密度超过阈值后，价格行为与随机无差异
**H₁（研究假设）**：清算密度超过阈值后，价格加速度显著增加

### 2. 事件定义（机械化）
```python
event = (liquidation_volume_1h > quantile(liquidation_volume_1h, 0.90))
```

### 3. 观察变量
- 未来 1h 价格变化率
- 未来 1h 价格加速度
- 未来 1h 波动率

### 4. 预期效应
- 方向：价格加速（正或负）
- 强度：Cohen's d > 0.3
- 持续：至少 30 分钟

### 5. 数据需求
- 清算数据（Coinglass API）
- 1 分钟 K 线（Binance API）
- 时间范围：2023-01-01 ~ 2026-01-30

### 6. 验证优先级
- 优先级：HIGH（有学术支持）
- 预期通过率：60%
- 验证时间：1 周
```

---

## 三、策略候选池管理

### 3.1 状态标记系统（基于弱信号组合哲学）

| 状态 | 含义 | 判定标准 | 下一步 |
|------|------|----------|--------|
| **NEW** | 刚加入候选池 | - | 分配验证资源 |
| **PENDING** | 等待验证 | - | 排队中 |
| **VALIDATING** | 验证中 | - | 等待结果 |
| **TIER 1** | 核心弱信号 | p < 0.05, 胜率 52-55% | 工程化为核心证人 |
| **TIER 2** | 辅助弱信号 | p < 0.20, 胜率 51-53% | 工程化为辅助证人 |
| **TIER 3** | 观察级信号 | p < 0.30, 胜率 50-52% | 继续观察或优化 |
| **FAIL** | 无效信号 | p > 0.30 或胜率 < 50% | 归档，分析失败原因 |
| **DEPRECATED** | 曾有效但失效 | 实盘表现 < 50% | 分析失效原因，生成新假设 |

**注意**：不再使用 PASS/WEAK 二分法，改用 TIER 1/2/3 分级，接受弱信号

---

### 3.2 优先级排序规则（基于弱信号组合）

**验证优先级（高到低）**：
1. 有学术支持 + 数据易得 + 预期 TIER 1/2
2. 数据挖掘发现 + 效应量适中（Cohen's d > 0.2）
3. 市场观察启发 + 逻辑清晰 + 可量化
4. 交易员经验 + 可机械化

**工程化优先级（高到低）**：
1. TIER 1 + 低风险 + 与现有证人低相关（核心证人）
2. TIER 2 + 低风险 + 互补现有证人（辅助证人）
3. TIER 1 + 中风险（需要更严格风控）
4. TIER 3（暂不工程化，继续观察）

**核心原则**：
- 不追求单个强信号（p < 0.01, 胜率 > 60%）
- 优先选择互补性强的弱信号组合
- 5-8 个证人组合可将整体胜率提升至 58-62%

---

## 四、验证层标准化流程（基于弱信号组合哲学）

### 4.1 验证检查清单

**阶段 1：事件定义检查**
- [ ] 完全机械化（无主观判断）
- [ ] 参数鲁棒性（±20% 不翻转）
- [ ] 可复现（代码 + 数据）

**阶段 2：统计检验（接受弱信号）**
- [ ] 方向偏移：
  - TIER 1: p_dir < 0.05（核心证人）
  - TIER 2: p_dir < 0.20（辅助证人）
  - TIER 3: p_dir < 0.30（观察级）
- [ ] 胜率检验：
  - TIER 1: 52-55%
  - TIER 2: 51-53%
  - TIER 3: 50-52%
- [ ] 效应量：Cohen's d > 0.2（确保有实际意义）
- [ ] 信息增益：KL > 0.01（提供独立信息）

**阶段 3：反事实检验**
- [ ] 随机对照组
- [ ] 真事件 vs 伪事件显著差异
- [ ] 跨时间段稳定性

**阶段 4：组合互补性检验**
- [ ] 与现有证人相关性 < 0.7（确保独立性）
- [ ] 提供不同市场视角
- [ ] 组合后整体胜率提升

**阶段 5：判决**
- [ ] 输出判决：TIER 1 / TIER 2 / TIER 3 / FAIL
- [ ] 记录验证报告
- [ ] 更新候选池状态

**核心原则**：
- 不追求 p < 0.01 的"强信号"（理论上不存在）
- 接受 p < 0.20 的弱信号（TIER 1/2）
- 关注信号组合后的整体表现

---

### 4.2 验证失败分析

**失败后必须回答**：
1. 为什么失败？
   - 假设本身错误
   - 数据质量问题
   - 验证方法不当

2. 有无替代假设？
   - 调整事件定义
   - 改变观察变量
   - 升级到更高维度

3. 是否值得继续？
   - 如果逻辑清晰 → 调整后重验
   - 如果逻辑模糊 → 放弃

---

## 五、自学习闭环详细设计

### 5.1 实盘反馈收集

**数据结构**：
```python
{
    "trade_id": "T-2026-001",
    "timestamp": "2026-01-30 10:00:00",
    "witnesses": [
        {"id": "W-001", "claim": "ELIGIBLE", "confidence": 0.85},
        {"id": "W-002", "claim": "ELIGIBLE", "confidence": 0.72}
    ],
    "decision": "OPEN_LONG",
    "execution": {
        "entry_price": 82500,
        "exit_price": 83200,
        "pnl": 700,
        "duration": "2h"
    },
    "market_context": {
        "volatility": 0.0012,
        "liquidity": "normal",
        "extreme_event": false
    }
}
```

---

### 5.2 证人健康度评分（基于弱信号组合）

**评分维度**：
1. **成功率**（40%）
   - TIER 1 目标：52-55%（优秀弱信号）
   - TIER 2 目标：51-53%（正常弱信号）
   - < 50%：失效信号

2. **夏普比率**（30%）
   - 收益 / 波动率
   - 目标：> 1.0（单个证人）

3. **最大回撤**（20%）
   - 单次最大亏损
   - 目标：< 10%

4. **稳定性**（10%）
   - 跨时间段表现一致性
   - 目标：成功率波动 < 5%

**健康度等级**：
- A（90-100）：核心证人（TIER 1，高权重）
- B（70-89）：辅助证人（TIER 2，中权重）
- C（50-69）：观察期（TIER 3，低权重或暂停）
- D（< 50）：失效证人（降权、沉默或剔除）

**核心原则**：
- 不追求单个证人 > 60% 成功率
- 关注证人组合后的整体表现（58-62%）
- 通过大样本累积验证弱信号有效性（> 100 笔交易）

---

### 5.3 假设工厂反馈机制

**失效证人分析**：
```
证人 W-001（波动率释放）失效
↓
分析失效原因：
- 市场波动率整体下降
- 低波动区间定义过时
↓
生成新假设：
- 假设：相对波动率（vs 30 天均值）更有效
- 假设：波动率 + 成交量联合事件
↓
加入候选池，优先验证
```

**成功证人扩展**：
```
证人 W-005（清算密度）表现优异
↓
分析成功特征：
- 清算量 > P90 时效果最好
- 配合订单簿失衡效果更好
↓
生成相似假设：
- 假设：清算密度 + 资金费率联合事件
- 假设：清算密度在不同时间段的差异
↓
加入候选池，优先验证
```

---

## 六、系统演进路径

### 6.1 短期（1-3 个月）

**目标**：建立基础闭环

1. **假设工厂 MVP**
   - 实现异常检测模块
   - 实现相关性分析模块
   - 每周输出 2-3 个新假设

2. **验证层标准化**
   - 统一验证脚本
   - 自动化验证流程
   - 验证报告模板

3. **候选池管理**
   - 状态标记系统
   - 优先级排序
   - 定期审查机制

---

### 6.2 中期（3-6 个月）

**目标**：实现自动化闭环

1. **假设工厂自动化**
   - 因果推断模块
   - 模式识别模块
   - 自动假设生成（每日）

2. **验证层并行化**
   - 多假设并行验证
   - 分布式回测
   - 加速验证周期

3. **自学习优化**
   - 证人权重自动调整
   - 失效证人自动分析
   - 新假设自动生成

---

### 6.3 长期（6-12 个月）

**目标**：形成自进化系统

1. **元学习**
   - 学习"什么样的假设容易成功"
   - 优化假设生成策略
   - 预测假设通过率

2. **市场适应**
   - 检测市场结构变化
   - 自动触发新一轮挖掘
   - 动态调整证人组合

3. **知识沉淀**
   - 假设库（成功/失败）
   - 验证方法库
   - 市场规律库

---

## 七、关键成功因素

### 7.1 数据质量

**必须保证**：
- 数据完整性（无缺失）
- 数据准确性（无错误）
- 数据时效性（实时更新）

**数据源优先级**：
1. 交易所官方 API（最可靠）
2. 专业数据平台（Glassnode, Kaiko）
3. 开源数据（需验证）

---

### 7.2 验证严格性

**不可妥协**：
- 反事实检验（必须做）
- 参数鲁棒性（必须测）
- 跨时间段验证（必须过）

**避免陷阱**：
- 参数调优 = p-hacking
- 只看好的结果
- 忽略失败案例

---

### 7.3 工程纪律

**必须遵守**：
- 假设先验证，再工程化
- 小资金测试，再放大
- 持续监控，及时止损

**禁止行为**：
- 未验证直接上线
- 过度自信
- 忽视风控

---

## 八、总结（基于弱信号组合哲学）

### 核心理念

> **这不是一个策略系统，而是一个策略工厂。**
> 
> **在高效市场中，不存在"强信号"（p < 0.01, 胜率 > 60%）。**
> 
> **系统的价值在于持续发现、验证、组合弱信号（p < 0.20, 胜率 52-55%），通过严格风控和大样本累积实现长期稳定盈利。**

### 竞争优势

1. **接受弱信号**：不追求圣杯策略，接受 TIER 1/2 弱信号
2. **组合增强**：5-8 个弱信号组合 → 整体胜率 58-62%
3. **数据驱动**：不依赖人工灵感，系统自动挖掘
4. **严格验证**：学术级标准，避免自欺欺人
5. **快速迭代**：自动化闭环，加速进化
6. **风控优先**：内核级风控，保证生存

### 最终目标

**建立一个能够自我进化的交易系统**：
- 市场变化 → 系统感知
- 旧策略失效 → 自动淘汰
- 新机会出现 → 自动发现
- 弱信号组合 → 持续优化
- 大样本累积 → 长期生存

**系统目标**：
- 年化收益：20-50%（而非 > 100%）
- 夏普比率：> 1.5
- 最大回撤：< 20%
- 核心目标：**长期生存 > 短期暴利**

---

**这才是真正的"自动交易系统"。**
