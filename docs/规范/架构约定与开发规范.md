---
inclusion: always
priority: critical
---

# BTC 自动交易系统 — 架构约定与开发规范

> **文档级别**：宪法级 / 所有开发必须遵守  
> **适用范围**：所有代码、所有模块、所有开发人员  
> **违反后果**：代码审查不通过 / 必须重构

---

## 🚨 宪法级原则（不可违反）

在开发任何功能前，必须确认不违反以下 5 条原则：

```
1. 策略无下单权
   ❌ 策略不能直接调用交易所 API
   ❌ 策略不能直接操作仓位
   ✅ 策略只能输出 Claim（声明）

2. 风控拥有硬否决权
   ❌ 任何模块不能绕过风控
   ❌ 风控决策不能被"建议化"
   ✅ 风控可以一票否决所有交易

3. 执行层必须幂等、可回滚
   ❌ 执行不能有副作用
   ❌ 执行不能不可逆
   ✅ 所有执行必须可审计、可回滚

4. 状态机是唯一交易入口
   ❌ 不能绕过状态机直接交易
   ❌ 不能有"后门"交易通道
   ✅ 所有交易必须经过状态机批准

5. 所有交易都可被审计与复盘
   ❌ 不能有"黑盒"交易
   ❌ 不能丢失交易日志
   ✅ 所有交易必须有完整日志
```

**检查方式**：在每次 PR 前，逐条检查你的代码是否违反上述原则。

---

## 🏛️ 三权分立架构（必须遵守）

### 权力层级

```
风控（Kernel Risk Control）
    ↓ 可以否决
状态机（Global State Machine）
    ↓ 可以批准
执行层（Execution Engine）
    ↓ 忠实执行
交易所（Market）
```

### 权力边界

#### 1. 状态权（Global State Machine）

**职责**：
- 决定系统是否允许交易
- 管理状态转换（OBSERVING / ELIGIBLE / ACTIVE_TRADING / COOLDOWN / RISK_LOCKED）

**允许做**：
- 接收策略 Claim
- 判断是否进入可交易态
- 触发 COOLDOWN

**禁止做**：
- ❌ 绕过风控
- ❌ 直接下单
- ❌ 修改策略权重

**代码检查**：
```python
# ❌ 错误示例
if strategy.signal == "BUY":
    exchange.place_order(...)  # 绕过状态机

# ✅ 正确示例
if state_machine.current_state == "ACTIVE_TRADING":
    if risk_control.check_permission():
        execution_engine.execute(order)
```

---

#### 2. 否决权（Kernel Risk Control）

**职责**：
- 判断系统是否具备交易资格
- 保护系统长期生存

**允许做**：
- 一票否决所有交易
- 强制进入 RISK_LOCKED
- 冻结系统

**禁止做**：
- ❌ 参与策略优劣评判
- ❌ 优化收益
- ❌ 被"建议化"

**代码检查**：
```python
# ❌ 错误示例
if risk_control.warning():  # 风控只是"警告"
    print("风险较高，但继续交易")
    execute_trade()

# ✅ 正确示例
if not risk_control.check_permission():  # 风控硬否决
    return "TRADE_REJECTED"
```

---

#### 3. 执行权（Execution Engine）

**职责**：
- 精确、可控、可审计地执行订单

**允许做**：
- 接收合法交易指令
- 保证幂等、可撤回、可确认
- 记录执行日志

**禁止做**：
- ❌ 判断行情
- ❌ 判断策略
- ❌ 绕过状态机或风控

**代码检查**：
```python
# ❌ 错误示例
def execute_order(order):
    if market.price > threshold:  # 执行层判断行情
        order.quantity *= 2
    exchange.place_order(order)

# ✅ 正确示例
def execute_order(order):
    # 只执行，不判断
    result = exchange.place_order(order)
    log_execution(order, result)
    return result
```

---

## 📋 模块职责边界（严格遵守）

### 策略层（Strategy）

**身份定位**：证人（Witness），不是决策者

**输出规范**：
```python
# ✅ 正确的策略输出
class StrategyOutput:
    strategy_id: str
    claim_type: str  # 白名单：MARKET_ELIGIBLE / REGIME_MATCHED / EXECUTION_VETO
    confidence: float  # 0~1
    validity_window: int  # 时间窗口
    constraints: dict  # 自我约束
```

**允许做**：
- 识别市场结构
- 判断是否"值得参与"
- 输出 Claim（声明）

**禁止做**：
- ❌ 计算最终仓位
- ❌ 直接定义止损执行
- ❌ 感知账户余额
- ❌ 直接下单
- ❌ 输出 BUY/SELL 指令

**代码检查**：
```python
# ❌ 错误示例
class Strategy:
    def run(self):
        if self.signal():
            return {"action": "BUY", "quantity": 100}  # 直接下单指令

# ✅ 正确示例
class Strategy:
    def run(self):
        if self.signal():
            return Claim(
                strategy_id="volatility_release",
                claim_type="MARKET_ELIGIBLE",
                confidence=0.75,
                validity_window=60
            )
```

---

### 自学习层（Learning）

**身份定位**：顾问（Advisor），不是执政者

**允许做**：
- 后验分析
- 影响策略权重（建议）
- 提供策略启停建议

**禁止做**：
- ❌ 直接影响实时交易
- ❌ 修改策略合约
- ❌ 改变策略分类
- ❌ 绕过人工审核

**代码检查**：
```python
# ❌ 错误示例
class LearningModule:
    def optimize(self):
        strategy.weight = 0.9  # 直接修改权重
        strategy.execute()  # 直接触发交易

# ✅ 正确示例
class LearningModule:
    def optimize(self):
        suggestion = {
            "strategy_id": "volatility_release",
            "suggested_weight": 0.9,
            "reason": "成功率提升至 55%",
            "requires_approval": True
        }
        return suggestion
```

---

## 🔒 状态机约束

### 状态定义

```
SYSTEM_INIT      # 系统初始化
    ↓
OBSERVING        # 观察市场
    ↓
ELIGIBLE         # 允许交易
    ↓
ACTIVE_TRADING   # 交易中
    ↓
COOLDOWN         # 冷却期
    ↓
RISK_LOCKED      # 风控锁定
    ↓
RECOVERY         # 恢复期
    ↓
OBSERVING        # 回到观察
```

### 状态转换规则

**允许的转换**：
- OBSERVING → ELIGIBLE（策略 Claim + 风控批准）
- ELIGIBLE → ACTIVE_TRADING（执行交易）
- ACTIVE_TRADING → COOLDOWN（交易完成）
- 任意状态 → RISK_LOCKED（风控触发）

**禁止的转换**：
- ❌ OBSERVING → ACTIVE_TRADING（绕过 ELIGIBLE）
- ❌ RISK_LOCKED → ELIGIBLE（绕过 RECOVERY）
- ❌ COOLDOWN → ACTIVE_TRADING（绕过 OBSERVING）

**代码检查**：
```python
# ❌ 错误示例
if market.signal():
    state = "ACTIVE_TRADING"  # 直接跳转

# ✅ 正确示例
if state == "OBSERVING" and strategy.claim():
    if risk_control.approve():
        state = "ELIGIBLE"
```

---

## 📊 弱信号组合哲学（必须理解）

### 核心认知

> **在高效市场中，不存在"强信号"（p < 0.01, 胜率 > 60%）。**
> 
> **系统价值在于组合多个弱信号（p < 0.20, 胜率 52-55%）。**

### 验证标准

**TIER 分级**：
- TIER 1: p < 0.05, 胜率 52-55%（核心证人）
- TIER 2: p < 0.20, 胜率 51-53%（辅助证人）
- TIER 3: p < 0.30, 胜率 50-52%（观察级）
- FAIL: p > 0.30 或胜率 < 50%（无效信号）

**不要追求**：
- ❌ p < 0.01 的"强信号"
- ❌ 胜率 > 60% 的"圣杯策略"
- ❌ 单个策略的完美表现

**应该关注**：
- ✅ 5-8 个弱信号组合
- ✅ 证人独立性（相关性 < 0.7）
- ✅ 组合后整体胜率 58-62%
- ✅ 大样本累积（> 100 笔交易）

**代码检查**：
```python
# ❌ 错误示例
if strategy.win_rate < 0.60:
    return "FAIL"  # 追求强信号

# ✅ 正确示例
if strategy.win_rate >= 0.52 and strategy.p_value < 0.05:
    return "TIER_1"  # 接受弱信号
```

---

## 🎯 系统目标（必须对齐）

### 目标定义

- **年化收益**：20-50%（而非 > 100%）
- **夏普比率**：> 1.5
- **最大回撤**：< 20%
- **核心目标**：长期生存 > 短期暴利

### 不要追求

- ❌ 月收益 100%
- ❌ 1 年暴利
- ❌ 极端高频交易
- ❌ 高杠杆

### 应该追求

- ✅ 5 年以上生存
- ✅ 稳定的风险调整收益
- ✅ 可控的回撤
- ✅ 系统健壮性

---

## 🔍 代码审查检查清单

在提交 PR 前，必须逐项检查：

### 架构层面
- [ ] 是否违反 5 条宪法级原则？
- [ ] 是否遵守三权分立？
- [ ] 是否遵守模块职责边界？

### 策略层面
- [ ] 策略是否只输出 Claim，不直接下单？
- [ ] 策略是否感知了账户余额？（禁止）
- [ ] 策略是否计算了最终仓位？（禁止）

### 风控层面
- [ ] 风控是否保留硬否决权？
- [ ] 风控决策是否可被绕过？（禁止）
- [ ] 风控是否参与了策略优劣评判？（禁止）

### 执行层面
- [ ] 执行是否可审计、可回滚？
- [ ] 执行是否有副作用？（禁止）
- [ ] 执行是否判断了行情？（禁止）

### 状态机层面
- [ ] 状态机是否是唯一交易入口？
- [ ] 是否存在绕过状态机的交易通道？（禁止）
- [ ] 状态转换是否合法？

### 自学习层面
- [ ] 自学习是否只提供建议，不直接干预？
- [ ] 自学习是否修改了策略合约？（禁止）
- [ ] 自学习结果是否经过审核？

### 弱信号组合层面
- [ ] 是否追求了"强信号"？（禁止）
- [ ] 验证标准是否使用 TIER 1/2/3 分级？
- [ ] 是否关注证人组合而非单一策略？
- [ ] 是否需要大样本验证（> 100 笔）？

---

## 📝 命名规范

### 模块命名

- 策略模块：`strategy_*.py`
- 风控模块：`risk_*.py`
- 状态机模块：`state_*.py`
- 执行模块：`execution_*.py`
- 学习模块：`learning_*.py`

### 函数命名

**策略层**：
- `generate_claim()` ✅
- `execute_trade()` ❌（策略不能执行）

**风控层**：
- `check_permission()` ✅
- `suggest_risk()` ❌（风控不是建议）

**执行层**：
- `execute_order()` ✅
- `analyze_market()` ❌（执行层不分析）

---

## 🚫 禁止模式（Anti-Patterns）

### 1. 策略直接下单

```python
# ❌ 禁止
class Strategy:
    def run(self):
        if self.signal():
            exchange.buy(100)  # 直接下单
```

### 2. 绕过风控

```python
# ❌ 禁止
if not risk_control.approve():
    # 绕过风控继续交易
    execute_anyway()
```

### 3. 绕过状态机

```python
# ❌ 禁止
if strategy.signal():
    execution_engine.execute()  # 绕过状态机
```

### 4. 执行层判断策略

```python
# ❌ 禁止
def execute_order(order):
    if market.trend == "up":  # 执行层判断
        order.quantity *= 2
```

### 5. 自学习直接干预

```python
# ❌ 禁止
class Learning:
    def optimize(self):
        strategy.weight = 0.9  # 直接修改
        strategy.execute()  # 直接触发
```

### 6. 追求强信号

```python
# ❌ 禁止
if strategy.p_value > 0.01:
    return "FAIL"  # 只接受 p < 0.01
```

---

## ✅ 推荐模式（Best Practices）

### 1. 策略输出 Claim

```python
# ✅ 推荐
class Strategy:
    def run(self):
        if self.signal():
            return Claim(
                strategy_id="volatility_release",
                claim_type="MARKET_ELIGIBLE",
                confidence=0.75
            )
```

### 2. 风控硬否决

```python
# ✅ 推荐
if not risk_control.check_permission():
    return "TRADE_REJECTED"
```

### 3. 状态机批准

```python
# ✅ 推荐
if state_machine.current_state == "ELIGIBLE":
    if risk_control.approve():
        execution_engine.execute(order)
```

### 4. 执行层忠实执行

```python
# ✅ 推荐
def execute_order(order):
    result = exchange.place_order(order)
    log_execution(order, result)
    return result
```

### 5. 自学习提供建议

```python
# ✅ 推荐
class Learning:
    def optimize(self):
        return {
            "strategy_id": "volatility_release",
            "suggested_weight": 0.9,
            "requires_approval": True
        }
```

### 6. 接受弱信号

```python
# ✅ 推荐
if 0.52 <= strategy.win_rate <= 0.55 and strategy.p_value < 0.05:
    return "TIER_1"  # 接受弱信号
```

---

## 📚 必读文档

在开发前，必须阅读以下文档：

1. **核心哲学**（30 分钟）
   - `docs/00-核心哲学/弱信号组合哲学与设计原则.md`
   - `docs/00-核心哲学/系统级架构冻结文档.md`

2. **系统设计**（1 小时）
   - `docs/01-系统设计/全局状态机PRD.md`
   - `docs/01-系统设计/内核级风控PRD.md`
   - `docs/01-系统设计/执行合约PRD.md`
   - `docs/01-系统设计/策略合约PRD.md`

3. **验证方法**（30 分钟）
   - `docs/02-验证方法/策略筛选优先级清单.md`

---

## 🎯 总结

### 一句话原则

> **这是一个"交易操作系统内核"，而不是一个策略集合。**
> 
> **盈利能力来自策略，生存能力来自架构，长期收益来自约束。**

### 核心价值观

1. **风控优先于策略**：即使策略失效，只要风控有效，系统依然可以生存
2. **架构优先于功能**：即使功能不完善，只要架构正确，系统可以演进
3. **约束优先于自由**：即使约束限制了灵活性，但保证了系统安全
4. **生存优先于盈利**：即使短期收益不高，但长期生存才是核心

### 开发心态

- ❌ 不要想："这个约束太麻烦，我绕过去"
- ✅ 应该想："这个约束保护了系统，我遵守它"

- ❌ 不要想："我的策略很厉害，应该直接下单"
- ✅ 应该想："我的策略是证人，需要经过裁决"

- ❌ 不要想："风控太严格，影响了收益"
- ✅ 应该想："风控保证了生存，生存才有收益"

---

**记住：违反架构约定的代码，再优秀也不会被合并。**

**遵守架构约定的代码，即使简单也是有价值的。**
