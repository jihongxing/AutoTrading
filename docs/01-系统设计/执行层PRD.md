# BTC 自动交易系统 — 执行层 PRD（文字版）

## 1️ 目的

执行层负责将策略裁决层和风控/宏观证人的批准信号，**安全、高效、可控地转化为实际交易操作**。  
目标：

- 忠实执行策略信号
    
- 保证交易安全、避免爆仓
    
- 可审计、可回滚，确保大资金操作的可靠性
    
- 支持多单、空单、仓位管理及动态止盈/止损
    

---

## 2️ 功能模块

### 2.1 下单与开平仓

- **功能**：执行裁决后的交易信号，开多单或空单
    
- **输入**：
    
    - 核心盈利证人信号（多/空方向、仓位建议）
        
    - 风控/宏观证人批准状态（冻结/否决）
        
    - 当前仓位状态
        
- **操作**：
    
    - 下单到交易所 API
        
    - 支持批量拆单或加权下单
        
    - 按策略提供的仓位比例开多/空单
        
- **输出**：订单确认、仓位更新、日志记录
    

---

### 2.2 仓位管理

- **功能**：保证开仓总量符合系统仓位限制
    
- **输入**：
    
    - 当前持仓量
        
    - 系统仓位上限、策略建议仓位
        
- **操作**：
    
    - 按策略权重分配仓位
        
    - 支持加仓、减仓、部分平仓
        
    - 遇风控冻结或 RISK_LOCKED → 自动限制仓位
        
- **输出**：实时仓位状态、异常告警
    

---

### 2.3 动态止盈 / 止损

- **功能**：确保收益落袋、避免爆仓
    
- **输入**：
    
    - 策略层提供的目标止盈/止损点
        
    - 风控证人动态止损建议
        
- **操作**：
    
    - 自动触发平仓操作
        
    - 支持部分止盈/止损、加权调整
        
- **输出**：订单成交记录、仓位更新、日志记录
    

---

### 2.4 撤单与回滚

- **功能**：处理未执行或部分执行订单，保证系统一致性
    
- **触发条件**：
    
    - 风控/宏观证人触发冻结或否决
        
    - 状态机进入 RISK_LOCKED 或 COOLDOWN
        
    - 市场极端波动
        
- **操作**：
    
    - 自动撤销未完成订单
        
    - 回滚已下单仓位和资金状态
        
- **输出**：撤单记录、日志审计
    

---

### 2.5 执行安全与日志

- **功能**：确保大资金操作可审计、异常可追踪
    
- **操作**：
    
    - 所有下单、平仓、撤单操作记录日志
        
    - 异常交易或未完成订单触发告警
        
    - 系统状态、仓位、信号来源完整记录
        
- **输出**：可回放、可审计日志
    

---

### 2.6 并发与高可用

- **功能**：保证多信号并行执行安全
    
- **操作**：
    
    - 队列或锁机制保证订单顺序
        
    - 防止仓位超限或冲突
        
    - 支持并发信号下单与状态更新
        

---

## 3️ 接口定义示例（工程化）

|接口|输入|输出|描述|
|---|---|---|---|
|`/execute_order`|信号方向（多/空）、仓位、止盈止损、策略来源、审批状态|订单执行结果、仓位状态、日志|核心下单接口|
|`/cancel_order`|订单ID、撤单原因|撤单结果、仓位恢复、日志|撤单接口|
|`/update_position`|仓位调整指令|仓位更新、日志|仓位加权/部分平仓接口|
|`/freeze_trading`|风控/宏观冻结触发|冻结确认、日志|冻结/硬否决接口|
|`/log_event`|交易事件、状态快照|成功/失败确认|系统日志记录接口|

---

## 4️ 执行原则

1. **忠实执行**：仅执行批准信号，不参与策略判断
    
2. **安全优先**：任何风控/宏观冻结必须立即生效
    
3. **低延迟高可靠**：确保大资金重仓操作准确执行
    
4. **可审计可回滚**：每笔交易、仓位调整和撤单都有完整记录
    

---

## 5️ 系统流程（文字版）

```text
策略证人信号 → 裁决层整合 → 风控/宏观证人审批
    ↓
信号通过 → 执行层下单/平仓/加减仓 → 仓位更新 → 日志记录
信号冻结或否决 → 执行层撤单/冻结 → 仓位回滚 → 日志记录

```

## 6 执行层文字版流程示意

```text
┌─────────────────────────────┐
│ 1. 策略证人信号产生         │
│ (多单/空单、仓位建议、止盈止损目标) │
└───────────────┬─────────────┘
                │
                ▼
┌─────────────────────────────┐
│ 2. 裁决层整合信号           │
│ - 多策略投票/权重合并       │
│ - 核心证人、高权重证人优先 │
└───────────────┬─────────────┘
                │
                ▼
┌─────────────────────────────┐
│ 3. 风控/宏观证人审批        │
│ - 仓位限制检查               │
│ - 最大回撤检查               │
│ - 波动率过大冻结信号         │
│ - 宏观事件/政策否决          │
└───────┬─────────────────────┘
        │
  ┌─────┴─────┐
  │           │
  ▼           ▼
信号通过      信号冻结或否决
  │           │
  │           └─► 执行层撤单/冻结所有未完成订单
  │                更新仓位，回滚已下单状态
  │
  ▼
┌─────────────────────────────┐
│ 4. 执行层下单/平仓/加减仓    │
│ - 开多单/空单                │
│ - 部分平仓/加权调整仓位      │
│ - 动态止盈/止损触发          │
│ - 严格遵守审批信号           │
└───────────────┬─────────────┘
                │
                ▼
┌─────────────────────────────┐
│ 5. 仓位状态更新与日志记录    │
│ - 实时更新仓位、账户余额     │
│ - 记录交易、撤单、冻结操作   │
│ - 异常告警触发              │
└─────────────────────────────┘

说明：
- 执行层不参与策略判断，仅负责忠实、安全地执行批准信号
- 风控/宏观证人可随时触发冻结/否决，强制执行层停止交易
- 所有操作可审计、可回放、可回滚
- 仓位管理、动态止盈/止损由执行层落实，策略层只提供目标和建议

```


## 7、高交易窗口判定文字版流程示意

```text
┌─────────────────────────────┐
│ 1. 策略层 / 策略编排 PRD    │
│ 高交易窗口判定逻辑所在位置   │
│ 输入：                        │
│ - 核心证人信号（波动率释放+区间破坏） │
│ - 辅助证人信号（时间结构优势、微结构异常等） │
│ - 当前市场行情（价格、成交量、波动率、深度） │
│ 输出：                        │
│ - 是否属于高交易窗口           │
│ - 建议仓位放大系数             │
└───────────────┬─────────────┘
                │
                ▼
┌─────────────────────────────┐
│ 2. 执行层 / 执行层 PRD        │
│ 输入：                        │
│ - 高交易窗口判定结果           │
│ - 建议仓位放大系数             │
│ 输出：                        │
│ - 实际下单仓位调整             │
│ - 动态止盈止损放大/缩减        │
└───────────────┬─────────────┘
                │
                ▼
┌─────────────────────────────┐
│ 3. 自学习 / 自学习自优化 PRD  │
│ 输入：                        │
│ - 历史交易数据（信号、执行结果、盈亏） │
│ - 高交易窗口判定记录           │
│ 输出：                        │
│ - 优化高交易窗口判定阈值        │
│ - 调整信号权重与窗口评分方法    │
│ - 建议调整放大系数或冻结窗口    │
└───────────────┘

说明：
1. 高交易窗口判定逻辑属于策略层，但其输出影响执行层的仓位和止盈止损策略。
2. 自学习模块周期性优化高交易窗口判定规则和阈值。
3. 执行层只使用窗口输出，不参与判定逻辑本身。
4. 形成完整闭环：
   策略层判定 → 执行层应用 → 自学习反馈 → 策略层优化

```
