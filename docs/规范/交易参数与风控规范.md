---
inclusion: always
priority: high
---

# BTC 自动交易系统 — 交易参数与风控规范

> **文档级别**：交易规范  
> **适用范围**：所有交易相关代码  
> **核心原则**：参数分层管理，明确可变性边界

---

## 0️⃣ 参数分类原则（重要）

### 参数四层分类

| 层级 | 名称 | 可变性 | 修改方式 | 存储位置 |
|------|------|--------|----------|----------|
| **L0** | 宪法级 | 🔒 不可变 | 永不修改 | 硬编码 |
| **L1** | 系统配置 | ⚙️ 可配置 | 人工修改，重启生效 | `config/*.yaml` |
| **L2** | 风控阈值 | 🛡️ 受控可调 | 人工审批后修改 | `config/risk.yaml` |
| **L3** | 自学习参数 | 📊 动态调整 | 系统自动优化（有边界） | 数据库 |

### 分类原则

```
L0 宪法级：保护系统架构完整性，永不改变
L1 系统配置：运维层面的配置，不影响交易逻辑
L2 风控阈值：影响系统安全，需人工审批
L3 自学习参数：系统可自动优化，但有严格边界
```

---

## 1️⃣ L0 宪法级参数（🔒 不可变）

> **这些是架构约束，硬编码在系统中，永不修改**

### 架构约束

```python
class ArchitectureConstants:
    """宪法级常量 - 永不修改"""
    
    # 三权分立
    STRATEGY_CAN_PLACE_ORDER = False      # 策略无下单权
    RISK_CONTROL_HAS_VETO = True          # 风控硬否决权
    STATE_MACHINE_IS_ONLY_ENTRY = True    # 状态机是唯一入口
    
    # 证人体系
    TIER3_HAS_ABSOLUTE_VETO = True        # TIER3 一票否决
    MIN_WITNESSES_FOR_TRADE = 2           # 最少 2 个证人同意
    
    # 风控优先级
    RISK_PRIORITY_OVER_STRATEGY = True    # 风控优先于策略
```

### 不可变规则

| 规则 | 说明 |
|------|------|
| 策略无下单权 | 策略只能输出 Claim，不能直接下单 |
| 风控硬否决 | 风控决策不接受任何反驳 |
| 状态机唯一入口 | 所有交易必须经过状态机 |
| TIER3 一票否决 | 否决证人可以直接拒绝交易 |

---

## 2️⃣ L1 系统配置参数（⚙️ 可配置）

> **运维可调，修改后重启生效，不影响交易逻辑**

### 交易所配置

| 参数 | 默认值 | 可选值 | 说明 |
|------|--------|--------|------|
| 主交易所 | Binance | Binance / OKX / Bybit | 流动性优先 |
| 备用交易所 | OKX | OKX / Bybit | 故障切换 |
| API 限流 | 1200次/分 | 依交易所 | 避免被封 |
| 订单类型 | 市价+限价 | 市价 / 限价 / 条件单 | 执行策略 |

### 告警配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| Telegram 通知 | 启用 | 快速告警 |
| 邮件通知 | 启用 | 重要告警 |
| 短信通知 | 仅 CRITICAL | 紧急告警 |

### 回测配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 数据范围 | 3 年 | 覆盖多周期 |
| 数据粒度 | 1 分钟 | 最小粒度 |
| 手续费假设 | 0.1% | 保守估计 |
| 滑点假设 | 0.1% | 保守估计 |

### 配置文件示例

```yaml
# config/system.yaml
exchange:
  primary: "binance"
  backup: "okx"
  api_rate_limit: 1200

alerts:
  telegram:
    enabled: true
    bot_token: ${TELEGRAM_BOT_TOKEN}
  email:
    enabled: true
    smtp_server: smtp.gmail.com

backtest:
  data_years: 3
  commission_rate: 0.001
  slippage_rate: 0.001
```

---

## 3️⃣ L2 风控阈值参数（🛡️ 受控可调）

> **影响系统安全，修改需人工审批，有变更日志**

### 账户级风控

| 参数 | 默认值 | 允许范围 | 修改审批 |
|------|--------|----------|----------|
| 最大回撤 | 20% | 15%-30% | 需审批 |
| 单日最大亏损 | 3% | 2%-5% | 需审批 |
| 连续亏损触发 | 3 次 | 2-5 次 | 需审批 |
| 周最大亏损 | 10% | 5%-15% | 需审批 |

### 市场级风控

| 参数 | 默认值 | 允许范围 | 修改审批 |
|------|--------|----------|----------|
| 波动率阈值 | ATR > 2x | 1.5x-3x | 需审批 |
| 流动性阈值 | 价差 > 0.5% | 0.3%-1% | 需审批 |
| 极端波动 | 1h 涨跌 > 10% | 5%-15% | 需审批 |

### 仓位限制

| 参数 | 默认值 | 允许范围 | 修改审批 |
|------|--------|----------|----------|
| 最大单笔仓位 | 5% | 3%-10% | 需审批 |
| 最大总仓位 | 30% | 20%-50% | 需审批 |
| 杠杆上限 | 5x | 3x-10x | 需审批 |

### 冷却期

| 参数 | 默认值 | 允许范围 | 修改审批 |
|------|--------|----------|----------|
| 正常冷却 | 10 分钟 | 5-30 分钟 | 需审批 |
| 止损后冷却 | 20 分钟 | 10-60 分钟 | 需审批 |
| 连续亏损冷却 | 1 小时 | 30 分钟-4 小时 | 需审批 |

### 配置文件示例

```yaml
# config/risk.yaml
# ⚠️ 修改此文件需要审批，所有变更记录在 changelog

account_risk:
  max_drawdown: 0.20           # 允许范围: 0.15-0.30
  daily_max_loss: 0.03         # 允许范围: 0.02-0.05
  consecutive_loss_cooldown: 3 # 允许范围: 2-5
  weekly_max_loss: 0.10        # 允许范围: 0.05-0.15

market_risk:
  volatility_threshold_multiplier: 2.0  # 允许范围: 1.5-3.0
  liquidity_threshold: 0.005            # 允许范围: 0.003-0.01
  extreme_volatility_threshold: 0.10    # 允许范围: 0.05-0.15

position:
  max_single_position: 0.05    # 允许范围: 0.03-0.10
  max_total_position: 0.30     # 允许范围: 0.20-0.50
  max_leverage: 5              # 允许范围: 3-10

cooldown:
  normal_seconds: 600          # 允许范围: 300-1800
  stop_loss_seconds: 1200      # 允许范围: 600-3600
  consecutive_loss_seconds: 3600  # 允许范围: 1800-14400

# 变更日志
# 2026-01-30: 初始配置
```

---

## 4️⃣ L3 自学习参数（📊 动态调整）

> **系统自动优化，但有严格边界约束**

### 可自学习调整的参数

| 参数 | 默认值 | 调整范围 | 调整频率 |
|------|--------|----------|----------|
| 证人权重 | 0.5 | 0.1 - 0.9 | 每日 |
| 仓位放大系数 | 1.0x | 0.5x - 1.5x | 每日 |
| 默认仓位比例 | 2% | 1% - 3% | 每周 |
| 止损微调 | 2% | 1.5% - 2.5% | 每周 |
| 止盈微调 | 3% | 2.5% - 3.5% | 每周 |

### 自学习边界约束

```python
# 自学习可调整的范围（硬边界）
LEARNING_BOUNDS = {
    # 证人权重
    "witness_weight": (0.1, 0.9),
    
    # 仓位相关
    "position_multiplier": (0.5, 1.5),
    "default_position_ratio": (0.01, 0.03),
    
    # 止盈止损微调
    "stop_loss_adjustment": (-0.005, 0.005),  # ±0.5%
    "take_profit_adjustment": (-0.005, 0.005),  # ±0.5%
    
    # 单次调整幅度
    "max_daily_weight_change": 0.05,  # 每日最多±5%
}

# 自学习禁止触碰的参数（L2 风控阈值）
LEARNING_FORBIDDEN = [
    "max_drawdown",
    "daily_max_loss",
    "max_leverage",
    "max_single_position",
    "max_total_position",
]
```

### 证人健康度管理（自学习驱动）

| 等级 | 成功率 | 样本量 | 自动动作 |
|------|--------|--------|----------|
| A 级 | ≥55% | ≥50 笔 | 权重 +5% |
| B 级 | 52-55% | ≥50 笔 | 保持 |
| C 级 | 30-52% | ≥50 笔 | 权重 -5% |
| D 级 | <30% | ≥50 笔 | 自动 Mute |

### 自学习存储

```python
# 自学习参数存储在数据库
class WitnessLearningConfig(BaseModel):
    """证人自学习配置"""
    witness_id: str
    weight: float = 0.5
    position_multiplier: float = 1.0
    stop_loss_adjustment: float = 0.0
    take_profit_adjustment: float = 0.0
    
    # 元数据
    updated_at: datetime
    updated_by: str  # "learning_system" or "human_override"
    version: int
    
    # 边界检查
    def validate_bounds(self):
        assert LEARNING_BOUNDS["witness_weight"][0] <= self.weight <= LEARNING_BOUNDS["witness_weight"][1]
        # ... 其他边界检查
```

---

## 5️⃣ 参数加载优先级

```python
def load_trading_params():
    """参数加载优先级"""
    
    # 1. L0 宪法级 - 硬编码，不可覆盖
    params = ArchitectureConstants()
    
    # 2. L1 系统配置 - 从 config/system.yaml 加载
    params.update(load_yaml("config/system.yaml"))
    
    # 3. L2 风控阈值 - 从 config/risk.yaml 加载
    params.update(load_yaml("config/risk.yaml"))
    
    # 4. L3 自学习参数 - 从数据库加载
    params.update(load_from_db("learning_params"))
    
    # 5. 边界检查 - 确保 L3 不越界
    validate_learning_bounds(params)
    
    return params
```

---

## 6️⃣ 参数修改流程

### L1 系统配置修改

```
1. 修改 config/system.yaml
2. 提交 PR，代码审查
3. 合并后重启服务生效
```

### L2 风控阈值修改

```
1. 提交修改申请（说明原因）
2. 风控负责人审批
3. 修改 config/risk.yaml
4. 记录变更日志
5. 重启服务生效
```

### L3 自学习参数

```
1. 自学习模块自动计算新参数
2. 边界检查（不能超出 LEARNING_BOUNDS）
3. 写入数据库
4. 实时生效（无需重启）
5. 记录调整日志
```

---

## 7️⃣ 默认值速查表

### L2 风控阈值默认值

```yaml
# 账户风控
max_drawdown: 20%
daily_max_loss: 3%
consecutive_loss_cooldown: 3 次
weekly_max_loss: 10%

# 市场风控
volatility_threshold: ATR > 2x
liquidity_threshold: 价差 > 0.5%
extreme_volatility: 1h 涨跌 > 10%

# 仓位限制
max_single_position: 5%
max_total_position: 30%
max_leverage: 5x

# 冷却期
normal_cooldown: 10 分钟
stop_loss_cooldown: 20 分钟
consecutive_loss_cooldown: 1 小时
```

### L3 自学习默认值

```yaml
# 证人权重
default_witness_weight: 0.5
core_auxiliary_ratio: 2:1

# 仓位
default_position_ratio: 2%
position_multiplier: 1.0x

# 止盈止损
default_stop_loss: 2%
default_take_profit: 3%
```

---

## 8️⃣ 监控与告警

### 参数变更告警

| 事件 | 告警级别 | 通知方式 |
|------|----------|----------|
| L2 参数修改 | WARNING | Telegram + 邮件 |
| L3 参数越界尝试 | ERROR | Telegram + 邮件 |
| L3 参数大幅调整 | INFO | 日志记录 |

### 自学习监控

```python
# 自学习调整监控
if abs(new_weight - old_weight) > 0.1:
    alert("证人权重大幅调整", level="WARNING")

if learning_param not in LEARNING_BOUNDS:
    alert("自学习参数越界", level="ERROR")
    reject_update()
```

---

## 📋 总结

| 层级 | 参数类型 | 修改方式 | 示例 |
|------|----------|----------|------|
| **L0** | 宪法级 | 永不修改 | 策略无下单权 |
| **L1** | 系统配置 | 人工修改 + 重启 | 交易所选择 |
| **L2** | 风控阈值 | 人工审批 + 重启 | 最大回撤 20% |
| **L3** | 自学习参数 | 系统自动 + 边界约束 | 证人权重 |

**核心原则**：
- L0 保护架构完整性
- L1 提供运维灵活性
- L2 保障系统安全性
- L3 实现自动优化

**自学习边界**：
- 只能调整 L3 参数
- 不能触碰 L2 风控阈值
- 所有调整有硬边界约束
